<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Server Verification Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-bottom: 10px; }
    h2 { color: #666; font-size: 18px; margin-top: 30px; }
    .subtitle { color: #666; margin-bottom: 30px; }
    .status {
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    button {
      padding: 12px 24px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-success:hover { background: #218838; }
    .btn-danger:hover { background: #c82333; }
    .result-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid #dee2e6;
    }
    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .comparison-item {
      border: 1px solid #dee2e6;
      padding: 15px;
      border-radius: 4px;
      background: #f8f9fa;
    }
    .comparison-item h3 {
      margin-top: 0;
      font-size: 16px;
      color: #495057;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê JWT Token Verification Test</h1>
    <p class="subtitle">Compare client-side vs server-side (Supabase) authentication verification</p>

    <div id="status" class="status info">
      Ready to test authentication...
    </div>

    <div>
      <button class="btn-primary" id="clientCheckBtn">Check Client-Side (isAuthenticated)</button>
      <button class="btn-success" id="serverCheckBtn">Verify with Server (Supabase)</button>
      <button class="btn-danger" id="clearBtn">Clear Session</button>
    </div>

    <h2>Client-Side Check Results</h2>
    <div id="clientResult" class="result-box">Click "Check Client-Side" button to see results...</div>

    <h2>Server-Side Verification Results</h2>
    <div id="serverResult" class="result-box">Click "Verify with Server" button to see results...</div>

    <div class="comparison">
      <div class="comparison-item">
        <h3>‚ú® Client-Side (isAuthenticated)</h3>
        <ul style="font-size: 13px; line-height: 1.6;">
          <li>Checks sessionStorage for token</li>
          <li>Verifies expiry date (3 days)</li>
          <li>Fast - no network request</li>
          <li>Good for UI state</li>
          <li><strong>Does NOT verify with Supabase</strong></li>
        </ul>
      </div>
      <div class="comparison-item">
        <h3>üîí Server-Side (verifyWithServer)</h3>
        <ul style="font-size: 13px; line-height: 1.6;">
          <li>Sends token to API endpoint</li>
          <li>Backend uses Supabase getUser()</li>
          <li>Verifies JWT signature</li>
          <li>Returns user data from Supabase</li>
          <li><strong>100% secure verification</strong></li>
        </ul>
      </div>
    </div>

    <h2>How It Works</h2>
    <div class="result-box" style="background: #fff; border-color: #007bff;">
<strong>Backend Flow (src/middleware/auth.ts):</strong>

1. GET /api/auth/verify (with Authorization: Bearer token)
2. requireAuth middleware extracts token
3. Supabase verifies JWT: supabaseClient.auth.getUser(token)
4. If valid: returns { authenticated: true, user: {...} }
5. If invalid: returns { authenticated: false }

<strong>Frontend Usage:</strong>

// Quick client check (no API call)
if (auth.isAuthenticated()) {
  // Token exists and not expired
}

// Verify with Supabase (API call)
const result = await auth.verifyWithServer();
if (result.authenticated) {
  // Token is valid according to Supabase
  console.log('User:', result.user);
}
    </div>
  </div>

  <script src="/js/auth.js"></script>
  <script>
    const statusDiv = document.getElementById('status');
    const clientResult = document.getElementById('clientResult');
    const serverResult = document.getElementById('serverResult');
    const clientCheckBtn = document.getElementById('clientCheckBtn');
    const serverCheckBtn = document.getElementById('serverCheckBtn');
    const clearBtn = document.getElementById('clearBtn');

    function showStatus(message, type = 'info') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }

    // Client-side check
    clientCheckBtn.addEventListener('click', () => {
      console.log('=== Running client-side check ===');

      const token = sessionStorage.getItem('jwt_token');
      const expiry = sessionStorage.getItem('jwt_expiry');
      const userData = sessionStorage.getItem('user_data');

      const isAuth = auth.isAuthenticated();

      let result = `Client-Side Authentication Check\n`;
      result += `================================\n\n`;
      result += `Result: ${isAuth ? '‚úÖ AUTHENTICATED' : '‚ùå NOT AUTHENTICATED'}\n\n`;
      result += `Token exists: ${!!token}\n`;
      result += `Expiry exists: ${!!expiry}\n`;

      if (expiry) {
        result += `Expiry date: ${new Date(expiry).toLocaleString()}\n`;
        result += `Is expired: ${new Date(expiry) < new Date()}\n`;
      }

      if (token) {
        result += `\nToken (first 40 chars): ${token.substring(0, 40)}...\n`;
      }

      if (userData) {
        const user = JSON.parse(userData);
        result += `\nUser email: ${user.email}\n`;
        result += `User ID: ${user.id}\n`;
      }

      result += `\nüìù Note: This only checks sessionStorage.\n`;
      result += `It does NOT verify the token with Supabase.`;

      clientResult.textContent = result;
      showStatus(isAuth ? '‚úÖ Client-side check: Authenticated' : '‚ùå Client-side check: Not authenticated', isAuth ? 'success' : 'error');
    });

    // Server-side verification
    serverCheckBtn.addEventListener('click', async () => {
      console.log('=== Running server-side verification ===');
      showStatus('üîÑ Verifying with server...', 'info');
      serverCheckBtn.disabled = true;

      try {
        const result = await auth.verifyWithServer();

        let output = `Server-Side Token Verification (Supabase)\n`;
        output += `==========================================\n\n`;
        output += `Result: ${result.authenticated ? '‚úÖ AUTHENTICATED' : '‚ùå NOT AUTHENTICATED'}\n\n`;

        if (result.authenticated && result.user) {
          output += `Verification Method: Supabase JWT verification\n`;
          output += `Endpoint: GET /api/auth/verify\n\n`;
          output += `User Information:\n`;
          output += `  - ID: ${result.user.id}\n`;
          output += `  - Email: ${result.user.email}\n`;
          output += `  - Full Name: ${result.user.full_name || 'N/A'}\n`;
          output += `  - Created: ${new Date(result.user.created_at).toLocaleString()}\n\n`;
          output += `‚úÖ Token is valid according to Supabase authentication.\n`;
          output += `The JWT signature was verified by Supabase.`;
        } else {
          output += `Reason: ${result.message || result.error || 'Unknown'}\n\n`;
          output += `‚ùå Token verification failed.\n`;
          output += `Possible reasons:\n`;
          output += `  - Token expired or invalid\n`;
          output += `  - Token signature doesn't match\n`;
          output += `  - User doesn't exist in Supabase\n`;
          output += `  - No token provided\n\n`;
          output += `Session has been cleared.`;
        }

        serverResult.textContent = output;
        showStatus(
          result.authenticated ? '‚úÖ Server verified: Token is valid!' : '‚ùå Server verification failed',
          result.authenticated ? 'success' : 'error'
        );
      } catch (error) {
        serverResult.textContent = `Server Verification Error:\n\n${error.message || error}`;
        showStatus('‚ùå Verification error', 'error');
      } finally {
        serverCheckBtn.disabled = false;
      }
    });

    // Clear session
    clearBtn.addEventListener('click', () => {
      auth.clearSession();
      clientResult.textContent = 'Session cleared. All authentication data removed from sessionStorage.';
      serverResult.textContent = 'Session cleared. Run verification again to see "not authenticated" response.';
      showStatus('üóëÔ∏è Session cleared', 'warning');
    });

    // Initial check on page load
    document.addEventListener('DOMContentLoaded', () => {
      const isAuth = auth.isAuthenticated();
      if (isAuth) {
        const user = auth.getUser();
        showStatus(`‚úÖ You are logged in as: ${user?.email || 'Unknown'}`, 'success');
      } else {
        showStatus('‚ö†Ô∏è Not logged in. Please login first at /login.html', 'warning');
      }
    });
  </script>
</body>
</html>
